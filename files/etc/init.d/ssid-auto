#!/bin/sh /etc/rc.common

START=99
STOP=15

USE_PROCD=1
NAME=ssid-auto
PROG=/usr/bin/ssid-auto
CONFIG=ssid-auto

validate_config() {
    # 检查必要工具是否存在
    if ! command -v iw >/dev/null && ! command -v iwinfo >/dev/null; then
        logger -t "$NAME" "ERROR: Neither iw nor iwinfo is installed"
        return 1
    fi
    
    # 验证配置有效性
    uci -q get "$CONFIG.global.enabled" || {
        logger -t "$NAME" "Config $CONFIG not found"
        return 1
    }
    
    return 0
}

start_service() {
    validate_config || return 1
    
    [ "$(uci -q get $CONFIG.global.enabled)" = "1" ] || {
        logger -t "$NAME" "Service disabled in config"
        return 0
    }

    procd_open_instance
    procd_set_param command "$PROG"
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
    
    logger -t "$NAME" "Started with pid $(pgrep -f $PROG)"
}

stop_service() {
    killall "$PROG" 2>/dev/null
    logger -t "$NAME" "Service stopped"
}

restart() {
    stop
    start
}
